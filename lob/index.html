<html lang=ja>

<head>
<meta charset="utf-8">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css"/>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="../js/tool.js"></script>
</head>

<body>
    <input type='search' id='input' />
    
    <div>
        <h2>検索結果</h2>
        <div id='results'></div>
    </div>
    
    <script>

// 本を検索して結果を返す
const searchBooks = async (query) => {
    const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${query}`);
    // JSON に変換
    const data = await res.json();
    // 必要なものだけ抜き出してわかりやすいフォーマットに変更する
    const items = data.items.map(item => {
        const vi = item.volumeInfo;
        return {
            title: vi.title,
            description: vi.description,
            link: vi.infoLink,
            image: vi.imageLinks ? vi.imageLinks.smallThumbnail : '',
        };
    });
    return items;
};

// 検索する
const search = async () => {
    const items = await searchBooks( $('#input').val() );
    const text = items.map( item => `
<li>
<img src="${item.image}" width="100" height="60">
<h1> ${item.title} </h1>
<h2>著者</h2>
<p> ${item.description} ${item.link} </p>
</li>` ).join('')
    $('#results').html(text)
};

let t = true
window.onload = async () => {
    // 入力するたびに検索( sleep で API 連打対策 )
    $('#input').change( async () => {
        if(t){
            search()
            t = false
            await sleep(256)
            t = true
        }
    } )
    
    // フォーカスしたら全文字選択
    $('#input').focus( () => {
        $('#input').select()
    })
};
    </script>
</body>